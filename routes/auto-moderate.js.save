// routes/ai-moderate.js – AI DUYỆT BÀI TỰ ĐỘNG SIÊU THÔNG MINH
import express from 'express';
import Post from '../models/Post.js'; // Đảm bảo đường dẫn đúng

const router = express.Router();

// Thay bằng key của bạn
const GEMINI_API_KEY = 'AIzaSyDMWt1l0ILrX_zyiVSjmdI6s3jwpF5Shjw'; // ← DÁN KEY CỦA BẠN VÀO ĐÂY
const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

router.post('/ai-moderate/:id', async (req, res) => {
  try {
    const post = await Post.findById(req.params.id).populate('author');
    if (!post || post.status !== 'pending') {
      return res.status(404).json({ error: 'Bài viết không tồn tại hoặc đã duyệt' });
    }

    const prompt = `
Bạn là Admin forum chuyên nghiệp, cực kỳ nghiêm khắc với nội dung xấu.
Hãy đọc bài viết sau và trả lời đúng định dạng JSON sau (không thêm gì thừa):

{
  "action": "approve" hoặc "reject",
  "reason": "Lý do ngắn gọn bằng tiếng Việt (tối đa 100 ký tự)",
  "suggestion": "Gợi ý chỉnh sửa nếu cần (nếu approve nhưng có lỗi nhỏ), hoặc để trống"
}

Nội dung bài viết:
Tiêu đề: ${post.title}
Nội dung: ${post.content}
${post.files?.length ? 'Có đính kèm ' + post.files.length + ' ảnh' : 'Không có ảnh'}
    `.trim();

    const response = await fetch(GEMINI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ role: 'user', parts: [{ text: prompt }] }]
      })
    });

    const data = await response.json();
    let aiDecision;
    try {
      const text = data.candidates[0].content.parts[0].text;
      aiDecision = JSON.parse(text.replace(/```json?|```/g, '').trim());
    } catch {
      return res.status(500).json({ error: 'AI trả lời sai định dạng' });
    }

    // TỰ ĐỘNG THỰC THI QUYẾT ĐỊNH CỦA AI
    if (aiDecision.action === 'approve') {
      post.status = 'approved';
      post.moderatedBy = 'AI';
      post.moderatedAt = new Date();
      await post.save();
    } else {
      post.status = 'rejected';
      post.rejectionReason = aiDecision.reason;
      post.moderatedBy = 'AI';
      await post.save();
    }

    res.json({
      success: true,
      ai: aiDecision,
      post: {
        id: post._id,
        title: post.title,
        status: post.status,
        reason: aiDecision.reason || aiDecision.suggestion
      }
    });

  } catch (err) {
    console.error('AI Moderate Error:', err);
    res.status(500).json({ error: 'Lỗi server AI' });
  }
});

export default router;
