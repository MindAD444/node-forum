<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forum - Trang ch·ªß</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">
      <span id="username-display"></span>
    </div>
    <div class="nav-right">
      <a href="index.html">Trang ch·ªß</a>
      <a href="create.html" id="create-link" class="hidden">ƒêƒÉng b√†i</a>
      <a href="admin.html" id="admin-link" class="hidden">Qu·∫£n tr·ªã</a>
      <a href="login.html" id="login-link">ƒêƒÉng nh·∫≠p</a>
      <a href="register.html" id="register-link">ƒêƒÉng k√Ω</a>
      <button id="logout-btn" class="btn-danger hidden">ƒêƒÉng xu·∫•t</button>
    </div>
  </nav>

  <main class="container">
    <h1>üìú Danh s√°ch b√†i vi·∫øt</h1>
    <div id="posts" class="post-list">ƒêang t·∫£i...</div>
  </main>

  <script>
    let currentUser = null; 

    document.addEventListener("DOMContentLoaded", () => {
      checkLoginStatus(); 
      loadPosts(); 
      document.getElementById("logout-btn").addEventListener("click", logout);
    });

    // --- LOGIC AUTH ---
    function checkLoginStatus() {
      const token = localStorage.getItem("token");
      const username = localStorage.getItem("username");
      const isAdmin = localStorage.getItem("isAdmin") === 'true';
      const userId = localStorage.getItem("userId"); 

      if (token && username) {
        document.getElementById("username-display").textContent = `Xin ch√†o, ${username}!`;
        document.getElementById("login-link").classList.add("hidden");
        document.getElementById("register-link").classList.add("hidden");
        document.getElementById("logout-btn").classList.remove("hidden");
        document.getElementById("create-link").classList.remove("hidden");
        
        currentUser = {
            _id: userId,
            username: username,
            isAdmin: isAdmin
        };

        if (isAdmin) {
          document.getElementById("admin-link").classList.remove("hidden");
        } else {
          document.getElementById("admin-link").classList.add("hidden");
        }
      } 
    }

    function logout() {
      localStorage.clear();
      window.location.reload();
    }
    
    // --- LOGIC B√ÄI VI·∫æT (T·ªêI ∆ØU DOM MANIPULATION) ---
    async function loadPosts() {
      try {
        const res = await fetch("/posts");
        const posts = await res.json();
        const container = document.getElementById("posts");
        
        if (!posts.length) {
          container.innerHTML = "<p>Ch∆∞a c√≥ b√†i vi·∫øt n√†o ƒë∆∞·ª£c duy·ªát.</p>";
          return;
        }

        const postHTML = posts.map(post => {
            let fileHTML = "";
            if (post.files && post.files.length > 0) {
                fileHTML = `<div class="file-section"><strong>üìé T·ªáp ƒë√≠nh k√®m:</strong><br>`;
                post.files.forEach(f => {
                    const ext = f.split('.').pop().toLowerCase();
                    if (["jpg","jpeg","png","gif"].includes(ext)) {
                        fileHTML += `<img src="${f}" class="post-image" alt="file" loading="lazy" />`;
                    } else {
                        fileHTML += `<a href="${f}" target="_blank" rel="noopener noreferrer">${f.split("/").pop()}</a><br>`;
                    }
                });
                fileHTML += `</div>`;
            }
            
            const canDelete = currentUser && 
                              (currentUser.isAdmin || currentUser._id === post.author?._id);
            const deleteButton = canDelete 
                                ? `<button class="delete-post-btn" data-id="${post._id}">üóëÔ∏è X√≥a b√†i</button>` 
                                : '';

            return `
                <div class="post-card" data-post-id="${post._id}">
                    <h2>${post.title}</h2>
                    <p class="post-content">${post.content}</p>
                    ${fileHTML}
                    <div class="post-meta">
                        üë§ <b>${post.author?.username || "·∫®n danh"}</b>
                        &nbsp;‚Ä¢&nbsp; üïì ${new Date(post.createdAt).toLocaleString()}
                        ${deleteButton}
                    </div>
                    <div id="comments-for-${post._id}" class="comment-section">
                        <button class="load-comments-btn" data-post-id="${post._id}">Xem/ƒêƒÉng b√¨nh lu·∫≠n</button>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = postHTML;
        setupPostEventListeners(); 

      } catch(err) {
        console.error("L·ªói khi t·∫£i b√†i vi·∫øt:", err);
        document.getElementById("posts").innerHTML = "<p>L·ªói khi t·∫£i b√†i vi·∫øt.</p>";
      }
    }
    
    function setupPostEventListeners() {
        // --- X·ª¨ L√ù N√öT X√ìA B√ÄI VI·∫æT ---
        document.querySelectorAll('.delete-post-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const postId = e.target.dataset.id;
                deletePost(postId);
            });
        });

        // --- X·ª¨ L√ù N√öT T·∫¢I B√åNH LU·∫¨N ---
        document.querySelectorAll('.load-comments-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const postId = e.target.dataset.postId;
                const commentSection = document.getElementById(`comments-for-${postId}`);
                if (commentSection.classList.contains('active')) {
                    // ƒê√≥ng b√¨nh lu·∫≠n
                    commentSection.innerHTML = `<button class="load-comments-btn" data-post-id="${postId}">Xem/ƒêƒÉng b√¨nh lu·∫≠n</button>`;
                    commentSection.classList.remove('active');
                    setupPostEventListeners(); 
                } else {
                    // M·ªü b√¨nh lu·∫≠n
                    commentSection.classList.add('active');
                    loadCommentSection(postId, commentSection);
                }
            });
        });
    }

    async function deletePost(postId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y kh√¥ng?")) return;
        
        try {
            const token = localStorage.getItem("token");
            const res = await fetch(`/posts/${postId}`, { 
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}` }
            });

            const data = await res.json();
            if (res.ok) {
                alert("X√≥a b√†i vi·∫øt th√†nh c√¥ng!");
                loadPosts(); 
            } else {
                alert(data.error || "L·ªói khi x√≥a b√†i vi·∫øt.");
            }
        } catch (err) {
            alert("L·ªói server.");
        }
    }

    // --- LOGIC B√åNH LU·∫¨N ---
    async function loadCommentSection(postId, container) {
        container.innerHTML = '<h4>B√¨nh lu·∫≠n</h4><div class="comment-list" id="comment-list-' + postId + '">ƒêang t·∫£i b√¨nh lu·∫≠n...</div>';
        
        try {
            const res = await fetch(`/comments/${postId}`);
            const comments = await res.json();
            
            const listContainer = document.getElementById(`comment-list-${postId}`);
            
            const commentHTML = comments.map(c => renderComment(c)).join('');
            listContainer.innerHTML = comments.length === 0 
                ? '<p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>' 
                : commentHTML;
            
            setupCommentEventListeners(postId);
            
            if (currentUser) {
                container.insertAdjacentHTML('beforeend', renderCommentForm(postId));
                setupCommentFormListener(postId);
            }

        } catch (err) {
            container.innerHTML = '<p>L·ªói khi t·∫£i b√¨nh lu·∫≠n.</p>';
        }
    }
    
    function renderComment(comment) {
        const canDelete = currentUser && 
                          (currentUser.isAdmin || currentUser._id === comment.author._id);
        const deleteButton = canDelete 
                            ? `<button class="delete-btn comment-delete-btn" data-id="${comment._id}" data-post-id="${comment.post}">X√≥a</button>` 
                            : '';
                            
        return `
            <div class="comment-item" id="comment-${comment._id}">
                <p><b>${comment.author?.username || "·∫®n danh"}</b>: ${comment.content}</p>
                <div class="comment-meta">
                    <span>${new Date(comment.createdAt).toLocaleString()}</span>
                    ${deleteButton}
                </div>
            </div>
        `;
    }
    
    function renderCommentForm(postId) {
        return `
            <form class="comment-form" data-post-id="${postId}">
                <textarea name="content" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." required></textarea>
                <button type="submit">ƒêƒÉng b√¨nh lu·∫≠n</button>
            </form>
        `;
    }

    function setupCommentFormListener(postId) {
        const form = document.querySelector(`.comment-form[data-post-id="${postId}"]`);
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = form.querySelector('textarea').value.trim();
            if (!content) return;

            try {
                const token = localStorage.getItem("token");
                const res = await fetch(`/comments/${postId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ content })
                });
                
                const newComment = await res.json();
                if (res.ok) {
                    const listContainer = document.getElementById(`comment-list-${postId}`);
                    // N·∫øu danh s√°ch r·ªóng, x√≥a th√¥ng b√°o "Ch∆∞a c√≥ b√¨nh lu·∫≠n"
                    if (listContainer.innerHTML.includes('Ch∆∞a c√≥ b√¨nh lu·∫≠n')) {
                        listContainer.innerHTML = '';
                    }
                    listContainer.insertAdjacentHTML('beforeend', renderComment(newComment));
                    form.querySelector('textarea').value = ''; 
                    setupCommentEventListeners(postId); 
                } else {
                    alert(newComment.error || "L·ªói khi ƒëƒÉng b√¨nh lu·∫≠n");
                }
            } catch (err) {
                alert("L·ªói server khi ƒëƒÉng b√¨nh lu·∫≠n.");
            }
        });
    }
    
    function setupCommentEventListeners(postId) {
        document.querySelectorAll(`#comment-list-${postId} .comment-delete-btn`).forEach(button => {
            button.addEventListener('click', (e) => {
                const commentId = e.target.dataset.id;
                deleteComment(commentId, postId);
            });
        });
    }

    async function deleteComment(commentId, postId) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?")) return;
      
      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`/comments/${commentId}`, { 
          method: "DELETE",
          headers: { "Authorization": `Bearer ${token}` }
        });

        const data = await res.json();
        if (res.ok) {
          document.getElementById(`comment-${commentId}`).remove();
          // Ki·ªÉm tra n·∫øu x√≥a h·∫øt th√¨ hi·ªÉn th·ªã th√¥ng b√°o
          const listContainer = document.getElementById(`comment-list-${postId}`);
          if (listContainer.children.length === 0) {
              listContainer.innerHTML = '<p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>';
          }
        } else {
          alert(data.error || "L·ªói khi x√≥a b√¨nh lu·∫≠n");
        }
      } catch (err) {
        alert("L·ªói server.");
      }
    }
  </script>
</body>
</html>

