<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản trị - Forum</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <nav class="navbar">
    <div class="nav-left">
      <a href="home.html" class="nav-brand">Forum</a>
    </div>
  </nav>

  <div class="admin-container">
    <div class="admin-header">
  <h1>Quản lý bài viết chờ duyệt</h1>
  <div class="pending-count" id="pending-count">Đang tải...</div>
    <div id="pending-posts">Đang tải bài viết chờ duyệt...</div>
</div>
  <script src="theme.js"></script>
<script>
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");
    if (!token || role !== "admin") {
      alert("Bạn không có quyền truy cập trang này!");
      window.location.href = "home.html";
    }

    async function loadPendingPosts() {
      try {
        const res = await fetch("/admin/pending", {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) {
          if (res.status === 403) return alert("Bạn không có quyền quản trị!");
          throw new Error("Lỗi tải dữ liệu");
        }

        const posts = await res.json();
        const container = document.getElementById("pending-posts");
        document.getElementById("pending-count").textContent = `${posts.length} bài đang chờ duyệt`;

        if (posts.length === 0) {
          container.innerHTML = `<p class="no-posts">Tất cả bài viết đã được duyệt!</p>`;
          return;
        }

        container.innerHTML = posts.map(p => `
          <div class="post-card-admin">
            <h3 class="post-title-admin">${escapeHtml(p.title)}</h3>
            
            <div class="post-meta-admin">
              <strong>Người đăng:</strong> ${p.author?.username || "Ẩn danh"}<br>
              (ID: ${p.author?._id || "N/A"})<br>
              <strong>Thời gian:<br></strong> ${new Date(p.createdAt).toLocaleString('vi-VN')}<br>
              <strong>ID bài viết:<br></strong> <code>${p._id}</code>
            </div>

            <div class="post-content-admin">${escapeHtml(p.content)}</div>
            ${p.files && p.files.length > 0 ? `
  <div class="post-images">
    ${p.files.map(rawUrl => {
      const url = rawUrl ? rawUrl.replace(/^http:\/\//i, 'https://') : '';
      return `
        <img src="${url || 'https://via.placeholder.com/300x200.png?text=No+Image'}"
             alt="Hình ảnh bài viết"
             onclick="window.open('${url}','_blank')"
             onerror="this.onerror=null; this.src='https://via.placeholder.com/300x200.png?text=Ảnh+lỗi'; this.style.opacity='0.6';"
             style="max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 12px; margin: 5px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
      `;
    }).join('')}
  </div>
` : ''}
            <div class="admin-actions">
              <button class="btn-approve" onclick="approvePost('${p._id}', this)">
                Duyệt bài
              </button>
              <button class="btn-reject" onclick="rejectPost('${p._id}', this)">
                Xóa bài
              </button>
              <button class="btn-ai" onclick="runAICheck('${p._id}', this)">Kiểm tra AI</button>
            </div>
          </div>
        `).join('');

      } catch (err) {
        document.getElementById("pending-posts").innerHTML = 
          `<p style="color:red;text-align:center;">Lỗi kết nối server: ${err.message}</p>`;
      }
    }

    async function approvePost(id, btn) {
      if (!confirm("Duyệt bài viết này?")) return;
      btn.disabled = true;
      btn.textContent = "Đang duyệt...";
      try {
        const res = await fetch(`/admin/approve/${id}`, {
          method: "PUT",
          headers: { "Authorization": `Bearer ${token}` }
        });
        if (res.ok) {
          btn.closest(".post-card-admin").style.opacity = "0.5";
          btn.closest(".post-card-admin").innerHTML += "<h2 style='color:green;text-align:center;margin:20px 0;'>ĐÃ DUYỆT</h2>";
          setTimeout(() => btn.closest(".post-card-admin").remove(), 1500);
          document.getElementById("pending-count").textContent = 
            (parseInt(document.getElementById("pending-count").textContent) - 1) + " bài đang chờ duyệt";
        } else {
          alert("Lỗi duyệt bài!");
        }
      } catch {
        alert("Lỗi server!");
      } finally {
        btn.disabled = false;
        btn.textContent = "Duyệt bài";
      }
    }

    async function rejectPost(id, btn) {
      if (!confirm("XÓA bài viết này? Hành động không thể hoàn tác!")) return;
      btn.disabled = true;
      btn.textContent = "Đang xóa...";
      try {
        const res = await fetch(`/admin/reject/${id}`, {
          method: "DELETE",
          headers: { "Authorization": `Bearer ${token}` }
        });
        if (res.ok) {
          btn.closest(".post-card-admin").style.opacity = "0.3";
          btn.closest(".post-card-admin").innerHTML += "<h2 style='color:red;text-align:center;margin:20px 0;'>ĐÃ XÓA</h2>";
          setTimeout(() => btn.closest(".post-card-admin").remove(), 1500);
          document.getElementById("pending-count").textContent = 
            (parseInt(document.getElementById("pending-count").textContent) - 1) + " bài đang chờ duyệt";
        } else {
          alert("Lỗi xóa bài!");
        }
      } catch {
        alert("Lỗi server!");
      } finally {
        btn.disabled = false;
        btn.textContent = "Xóa bài";
      }
    }

    async function runAICheck(id, btn) {
      if (!confirm('Chạy kiểm tra AI cho bài viết này?')) return;
      btn.disabled = true;
      btn.textContent = 'Đang kiểm tra...';
      try {
        const res = await fetch('/admin/auto-moderate/run-check', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ postId: id })
        });
        if (res.ok) {
          const data = await res.json();
          alert('Kết quả AI: ' + (data.result || JSON.stringify(data)));
        } else {
          const err = await res.json();
          alert('Lỗi AI: ' + (err.error || res.status));
        }
      } catch (e) {
        alert('Lỗi kết nối AI.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Kiểm tra AI';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }
setInterval(loadPendingPosts, 30000);
loadPendingPosts();
  </script>
</body>
</html>
