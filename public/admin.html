<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n tr·ªã - Forum</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <nav class="navbar">
    <div class="nav-left"><span id="username-display"></span></div>
    <div class="nav-right">
      <a href="index.html">Trang ch·ªß</a>
      <button id="logout-btn">ƒêƒÉng xu·∫•t</button>
    </div>
  </nav>

  <main class="container">
    <h1>üõ†Ô∏è Qu·∫£n l√Ω b√†i vi·∫øt ch·ªù duy·ªát</h1>
    <div id="admin-posts" class="post-list">ƒêang t·∫£i...</div>
  </main>

  <script>
  document.addEventListener("DOMContentLoaded", loadPendingPosts);

  async function loadPendingPosts() {
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "login.html";
      return;
    }

    try {
      const res = await fetch("/admin/posts", {
        headers: { "Authorization": "Bearer " + token },
      });
      const posts = await res.json();

      const container = document.getElementById("admin-posts");
      container.innerHTML = "";
      if (!posts.length) {
        container.innerHTML = "<p>Kh√¥ng c√≥ b√†i n√†o ch·ªù duy·ªát.</p>";
        return;
      }

      posts.forEach((post) => {
        let fileHTML = "";
        if (post.files && post.files.length > 0) {
          fileHTML = `<div class="file-section">`;
          post.files.forEach(f => {
            const ext = f.split('.').pop().toLowerCase();
            if (["jpg","jpeg","png","gif"].includes(ext)) {
              fileHTML += `<img src="${f}" class="post-image" alt="file" />`;
            } else {
              fileHTML += `<a href="${f}" target="_blank">${f.split("/").pop()}</a><br>`;
            }
          });
          fileHTML += `</div>`;
        }

        const div = document.createElement("div");
        div.className = "post-card";
        div.innerHTML = `
          <h2>${post.title}</h2>
          <p>${post.content}</p>
          ${fileHTML}
          <div class="post-meta">
            üë§ <b>${post.author?.username || "·∫®n danh"}</b>
            &nbsp;‚Ä¢&nbsp; üïì ${new Date(post.createdAt).toLocaleString()}
          </div>
          <div class="admin-actions">
            <button class="approve-btn" data-id="${post._id}">‚úÖ Duy·ªát</button>
            <button class="delete-btn" data-id="${post._id}">üóëÔ∏è X√≥a</button>
          </div>
        `;
        container.appendChild(div);
      });

      document.querySelectorAll(".approve-btn").forEach(btn =>
        btn.addEventListener("click", () => approvePost(btn.dataset.id, btn))
      );
      document.querySelectorAll(".delete-btn").forEach(btn =>
        btn.addEventListener("click", () => deletePost(btn.dataset.id, btn))
      );
    } catch {
      document.getElementById("admin-posts").innerHTML = "<p>L·ªói khi t·∫£i danh s√°ch.</p>";
    }
  }

  async function approvePost(id, btn) {
    const token = localStorage.getItem("token");
    btn.disabled = true;
    btn.textContent = "‚è≥ ƒêang duy·ªát...";
    try {
      const res = await fetch(`/admin/post/${id}`, {
        method: "PUT",
        headers: { "Authorization": "Bearer " + token },
      });
      const data = await res.json();
      if (res.ok) {
        btn.textContent = "‚úÖ ƒê√£ duy·ªát";
        btn.classList.add("approved");
        setTimeout(() => btn.closest(".post-card").remove(), 1000);
      } else {
        alert(data.message || "Kh√¥ng th·ªÉ duy·ªát b√†i");
        btn.disabled = false;
        btn.textContent = "‚úÖ Duy·ªát";
      }
    } catch {
      alert("L·ªói k·∫øt n·ªëi server.");
      btn.disabled = false;
      btn.textContent = "‚úÖ Duy·ªát";
    }
  }

  async function deletePost(id, btn) {
    const token = localStorage.getItem("token");
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i n√†y?")) return;
    try {
      const res = await fetch(`/admin/post/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token },
      });
      if (res.ok) {
        btn.closest(".post-card").remove();
      } else {
        alert("Kh√¥ng th·ªÉ x√≥a b√†i.");
      }
    } catch {
      alert("L·ªói k·∫øt n·ªëi server.");
    }
  }
  </script>
</body>
</html>
