<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÄÄƒng kÃ½ - Forum</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <nav class="navbar">
    <div class="nav-right">
      <a href="index.html">Trang chá»§</a>
      <a href="login.html">ÄÄƒng nháº­p</a>
    </div>
  </nav>

  <main class="form-container">
    <h1>Táº¡o tÃ i khoáº£n má»›i</h1>
    
    <form id="register-request-form">
      <input type="text" id="username" placeholder="TÃªn Ä‘Äƒng nháº­p" required />
      <input type="email" id="email" placeholder="Email" required />
      
      <div class="input-group">
        <input type="password" id="password" placeholder="Máº­t kháº©u (Tá»‘i thiá»ƒu 6 kÃ½ tá»±)" required minlength="6"/>
        <span class="toggle-password" data-target="password">ğŸ‘ï¸</span>
      </div>

      <div class="input-group">
        <input type="password" id="confirm-password" placeholder="XÃ¡c nháº­n máº­t kháº©u" required minlength="6"/>
        <span class="toggle-password" data-target="confirm-password">ğŸ‘ï¸</span>
      </div>
      <button type="submit">Gá»­i mÃ£ xÃ¡c thá»±c</button>
      <p>ÄÃ£ cÃ³ tÃ i khoáº£n?<a href="login.html">ÄÄƒng nháº­p</a>
    </form>
    <form id="register-verify-form" class="hidden">
      <p id="verify-info">MÃ£ xÃ¡c thá»±c 6 sá»‘ Ä‘Ã£ Ä‘Æ°á»£c gá»­i Ä‘áº¿n email <strong id="verify-email-display"></strong>. Vui lÃ²ng kiá»ƒm tra há»™p thÆ°.</p>
      <input type="text" id="verification-code" placeholder="MÃ£ xÃ¡c thá»±c (OTP) 6 sá»‘" required maxlength="6" pattern="\d{6}" title="MÃ£ xÃ¡c thá»±c pháº£i lÃ  6 chá»¯ sá»‘"/>
      <button type="submit">XÃ¡c nháº­n ÄÄƒng kÃ½</button>
      <button type="button" id="resend-code-btn" class="btn-secondary" style="margin-top: 10px;">Gá»­i láº¡i mÃ£</button>
    </form>
    
    <p id="message"></p>
  </main>
  <script src="theme.js"></script>
  <script src="app.js"></script>
  <script>
    if (localStorage.getItem('token')) {
        window.location.href = "home.html";
    }
    document.addEventListener("DOMContentLoaded", () => {
        const reqForm = document.getElementById("register-request-form");
        const verifyForm = document.getElementById("register-verify-form");
        const messageEl = document.getElementById("message");
        let tempUser = {}; 

        // --- Giai Ä‘oáº¡n 1: Gá»­i yÃªu cáº§u (Request) ---
        reqForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const username = document.getElementById("username").value.trim();
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();
            const confirmPassword = document.getElementById("confirm-password").value.trim(); 
            
            // KIá»‚M TRA Máº¬T KHáº¨U KHá»šP NHAU
            if (password !== confirmPassword) {
                messageEl.textContent = "âŒ Máº­t kháº©u vÃ  xÃ¡c nháº­n máº­t kháº©u khÃ´ng khá»›p.";
                return;
            }

            messageEl.textContent = "Äang gá»­i yÃªu cáº§u vÃ  mÃ£ xÃ¡c thá»±c...";

            try {
                const res = await fetch("/auth/register/request", { 
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    // Gá»­i Máº¬T KHáº¨U CHÃNH (Ä‘Ã£ Ä‘Æ°á»£c kiá»ƒm tra khá»›p)
                    body: JSON.stringify({ username, email, password }),
                });

                const data = await res.json();
                if (res.ok) {
                    tempUser = { username, email, password };
                    document.getElementById("verify-email-display").textContent = email;
                    reqForm.classList.add("hidden");
                    verifyForm.classList.remove("hidden");
                    messageEl.textContent = data.message;
                } else {
                    messageEl.textContent = data.error || "Lá»—i khi gá»­i mÃ£ xÃ¡c thá»±c.";
                }
            } catch {
                messageEl.textContent = "Lá»—i server. Vui lÃ²ng thá»­ láº¡i.";
            }
        });

        // --- Giai Ä‘oáº¡n 2: XÃ¡c thá»±c (Verify) & Gá»­i láº¡i mÃ£ (KhÃ´ng thay Ä‘á»•i) ---
        verifyForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const code = document.getElementById("verification-code").value.trim();
            
            if (code.length !== 6) {
                messageEl.textContent = "MÃ£ xÃ¡c thá»±c pháº£i cÃ³ 6 chá»¯ sá»‘.";
                return;
            }

            messageEl.textContent = "Äang xÃ¡c nháº­n mÃ£ vÃ  táº¡o tÃ i khoáº£n...";

            try {
                const res = await fetch("/auth/register/verify", { 
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: tempUser.email, code }),
                });

                const data = await res.json();
                if (res.ok) {
                    messageEl.textContent = "âœ… ÄÄƒng kÃ½ thÃ nh cÃ´ng! Äang chuyá»ƒn hÆ°á»›ng...";
                    setTimeout(() => window.location.href = "login.html", 2000);
                } else {
                    messageEl.textContent = data.error || "MÃ£ xÃ¡c thá»±c khÃ´ng Ä‘Ãºng hoáº·c Ä‘Ã£ háº¿t háº¡n.";
                }
            } catch {
                messageEl.textContent = "Lá»—i server khi táº¡o tÃ i khoáº£n.";
            }
        });
        
        document.getElementById("resend-code-btn").addEventListener("click", async () => {
             const username = tempUser.username;
             const email = tempUser.email;
             const password = tempUser.password;
             
             messageEl.textContent = "Äang gá»­i láº¡i mÃ£...";
             document.getElementById("resend-code-btn").disabled = true;

            try {
                const res = await fetch("/auth/register/request", { 
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, email, password }),
                });

                const data = await res.json();
                if (res.ok) {
                    messageEl.textContent = data.message;
                    setTimeout(() => {
                        document.getElementById("resend-code-btn").disabled = false;
                    }, 60000); // Cho phÃ©p gá»­i láº¡i sau 1 phÃºt
                } else {
                    messageEl.textContent = data.error || "Lá»—i khi gá»­i láº¡i mÃ£ xÃ¡c thá»±c.";
                    document.getElementById("resend-code-btn").disabled = false;
                }
            } catch {
                messageEl.textContent = "Lá»—i server. Vui lÃ²ng thá»­ láº¡i.";
                document.getElementById("resend-code-btn").disabled = false;
            }
        });

        // Logic áº¨n/Hiá»‡n Máº­t kháº©u (Cho cáº£ 2 trÆ°á»ng)
        document.querySelectorAll('.toggle-password').forEach(toggleBtn => {
            toggleBtn.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const passwordInput = document.getElementById(targetId);
                
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                
                // Thay Ä‘á»•i biá»ƒu tÆ°á»£ng: ğŸ‘ï¸ (hiá»‡n) <-> ğŸ”’ (áº©n)
                this.textContent = type === 'text' ? 'ğŸ”’' : 'ğŸ‘ï¸';
            });
        });
    });
  </script>
</body>
</html>
