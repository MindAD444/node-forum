<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÄÄƒng bÃ i má»›i - Forum</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">
      <a href="home.html" class="nav-brand">Trang chá»§</a>
    </div>
  </nav>

  <main class="container">
    <div class="create-post-container">
      <h1>âœï¸ ÄÄƒng bÃ i viáº¿t má»›i</h1>
      <form id="create-post-form" class="create-form">
        <input type="text" id="title" placeholder="TiÃªu Ä‘á» bÃ i viáº¿t (Tá»‘i Ä‘a 100 kÃ½ tá»±)" required maxlength="100"/>

        <textarea id="content" placeholder="Ná»™i dung bÃ i viáº¿t cá»§a báº¡n..." rows="10" required></textarea>

        <div class="file-upload-area">
          <label for="files">ğŸ“ Tá»‡p Ä‘Ã­nh kÃ¨m (Tá»‘i Ä‘a 5 file, &lt; 5MB/file)</label>
          <input type="file" id="files" name="files" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" multiple />
        </div>

        <button type="submit" id="submit-btn">Gá»­i bÃ i</button>
      </form>
      <p id="message" class="info-message"></p>
    </div>
  </main>

  <script src="theme.js"></script>
  <script src="app.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ Ä‘Äƒng bÃ i.");
        window.location.href = "login.html";
        return;
      }
      document.getElementById("create-post-form").addEventListener("submit", createPost);
      if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark");
      document.getElementById("theme-toggle")?.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
      });
    });
    async function createPost(e) {
      e.preventDefault();
      const title = document.getElementById("title").value.trim();
      const content = document.getElementById("content").value.trim();
      const files = document.getElementById("files").files;
      const messageEl = document.getElementById("message");
      const submitBtn = document.getElementById("submit-btn");

      if (files.length > 5) {
        messageEl.textContent = "Báº¡n chá»‰ cÃ³ thá»ƒ Ä‘Ã­nh kÃ¨m tá»‘i Ä‘a 5 tá»‡p.";
        return;
      }

      const formData = new FormData();
      formData.append("title", title);
      formData.append("content", content);

      for (let i = 0; i < files.length; i++) {
        if (files[i].size > 5 * 1024 * 1024) {
          messageEl.textContent = `Tá»‡p "${files[i].name}" quÃ¡ lá»›n. KÃ­ch thÆ°á»›c tá»‘i Ä‘a lÃ  5MB.`;
          return;
        }
        formData.append("files", files[i]);
      }

      const token = localStorage.getItem("token");
      messageEl.textContent = "Äang gá»­i bÃ i viáº¿t...";
      submitBtn.disabled = true;

      try {
        const res = await fetch("/posts", {
          method: "POST",
          headers: { "Authorization": `Bearer ${token}` },
          body: formData
        });

        const data = await res.json();

        if (res.ok) {
          messageEl.className = "success-message";
          messageEl.innerHTML = `âœ… ${data.message}. Vui lÃ²ng chá» admin duyá»‡t. <a href='home.html'>Quay vá» trang chá»§</a>`;
          document.getElementById("create-post-form").reset();
        } else {
          messageEl.className = "error-message";
          messageEl.textContent = data.error || "Lá»—i khi Ä‘Äƒng bÃ i viáº¿t.";
        }
      } catch (err) {
        messageEl.className = "error-message";
        messageEl.textContent = "Lá»—i káº¿t ná»‘i server.";
      } finally {
        submitBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
