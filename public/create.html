<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÄÄƒng bÃ i má»›i - Forum</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <nav class="navbar">
    <div class="nav-left"><span id="username-display"></span></div>
    <div class="nav-right">
      <a href="index.html">Trang chá»§</a>
      <button id="logout-btn">ÄÄƒng xuáº¥t</button>
    </div>
  </nav>

  <main class="form-container">
    <h1>ğŸ“ ÄÄƒng bÃ i má»›i</h1>
    <form id="post-form" enctype="multipart/form-data">
      <input type="text" id="title" placeholder="TiÃªu Ä‘á» bÃ i viáº¿t" required />
      <textarea id="content" rows="6" placeholder="Ná»™i dung bÃ i viáº¿t..." required></textarea>

      <label for="files" class="file-label">ÄÃ­nh kÃ¨m tá»‡p (tá»‘i Ä‘a 5 tá»‡p)</label>
      <input type="file" id="files" multiple accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />

      <div id="file-list" class="file-list"></div>

      <button type="submit">ÄÄƒng bÃ i</button>
    </form>
    <p id="message"></p>
  </main>

  <script>
  const filesInput = document.getElementById('files');
  const fileList = document.getElementById('file-list');
  filesInput.addEventListener('change', () => {
    fileList.innerHTML = '';
    const files = Array.from(filesInput.files);
    if (files.length === 0) {
      fileList.textContent = 'ChÆ°a chá»n tá»‡p nÃ o.';
      return;
    }
    const ul = document.createElement('ul');
    files.slice(0, 10).forEach(f => {
      const li = document.createElement('li');
      li.textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
      ul.appendChild(li);
    });
    fileList.appendChild(ul);
  });

  document.addEventListener("DOMContentLoaded", () => {
    if (!localStorage.getItem("token")) {
      window.location.href = "login.html";
    }
  });

  document.getElementById("post-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const title = document.getElementById("title").value.trim();
    const content = document.getElementById("content").value.trim();
    const files = document.getElementById("files").files;
    const token = localStorage.getItem("token");

    if (!token) {
      document.getElementById("message").textContent = "Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ Ä‘Äƒng bÃ i.";
      return;
    }

    const fd = new FormData();
    fd.append('title', title);
    fd.append('content', content);

    const MAX_FILES = 5;
    for (let i = 0; i < files.length && i < MAX_FILES; i++) {
      fd.append('files', files[i]);
    }

    try {
      const res = await fetch('/posts', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: fd
      });
      const data = await res.json();
      if (res.ok) {
        document.getElementById("message").textContent = "ÄÄƒng bÃ i thÃ nh cÃ´ng! Chá» duyá»‡t.";
        document.getElementById("post-form").reset();
        fileList.innerHTML = '';
      } else {
        document.getElementById("message").textContent = data.error || 'Lá»—i khi Ä‘Äƒng bÃ i.';
      }
    } catch (err) {
      document.getElementById("message").textContent = 'Lá»—i káº¿t ná»‘i tá»›i server.';
    }
  });
  </script>
</body>
</html>
