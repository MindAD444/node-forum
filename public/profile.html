<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H·ªì s∆° c√° nh√¢n - Forum</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <nav class="navbar">
    <div class="nav-left">
      <a href="home.html" class="nav-brand">Forum</a>
    </div>
    <div class="nav-right">
    </div>
  </nav>

  <main class="profile-container">
    <h2>H·ªì s∆° c√° nh√¢n</h2>
    
    <form id="profile-form">
      <div class="avatar-wrapper">
        <img id="avatar-preview" src="https://via.placeholder.com/150" alt="Avatar" class="profile-avatar">
        <label for="avatar-input" class="upload-label" title="ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán">üì∑</label>
        <input type="file" id="avatar-input" accept="image/*">
      </div>

      <div class="form-group">
        <label>Email (Kh√¥ng th·ªÉ ƒë·ªïi)</label>
        <input type="text" id="email" disabled placeholder="ƒêang t·∫£i...">
      </div>

      <div class="form-group">
        <label>T√™n hi·ªÉn th·ªã</label>
        <input type="text" id="username" placeholder="Nh·∫≠p t√™n m·ªõi" required>
      </div>
        <p id="username-cooldown" style="font-size: 0.9em; margin-top: 5px;"></p>
      </div>
      <button type="submit" class="save-btn" id="save-btn">L∆∞u thay ƒë·ªïi</button>
      <p id="msg"></p>
    </form>

    <hr style="margin: 40px 0; border: 0; border-top: 1px solid #ddd;">

    <h3>üîê ƒê·ªïi m·∫≠t kh·∫©u</h3>
    <form id="change-password-form">
      <div class="form-group">
        <label>M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
        <input type="password" id="current-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u c≈©" required>
      </div>

      <div class="form-group">
        <label>M·∫≠t kh·∫©u m·ªõi</label>
        <input type="password" id="new-password" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" required>
      </div>

      <div class="form-group">
        <label>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
        <input type="password" id="confirm-password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" required>
      </div>

      <button type="submit" class="save-btn" id="change-pwd-btn" style="background-color: #d9534f;">
        C·∫≠p nh·∫≠t m·∫≠t kh·∫©u
      </button>
      <p id="pwd-msg"></p>
    </form>
  </main>

  <script src="theme.js"></script>
  <script>
    // profile.html (trong th·∫ª <script>)

// Th√™m h√†m hi·ªÉn th·ªã th·ªùi gian cooldown
function formatRemainingTime(ms) {
    const totalDays = Math.ceil(ms / (1000 * 60 * 60 * 24));
    if (totalDays === 0) return "";
    return `B·∫°n c√≥ th·ªÉ ƒë·ªïi t√™n sau ${totalDays} ng√†y n·ªØa.`;
}

// üîë C·∫≠p nh·∫≠t h√†m loadProfile (ho·∫∑c th√™m ƒëo·∫°n code n√†y v√†o ph·∫ßn load data)
async function loadProfile() {
  // ... (Code l·∫•y token, fetch /auth/me) ...
  
  try {
    const res = await fetch("/auth/me", {
      headers: { "Authorization": `Bearer ${token}` }
    });
    const user = await res.json();
    
    // ... (Code hi·ªÉn th·ªã avatar, email, username c≈©) ...
    document.getElementById("email").value = user.email;
    document.getElementById("username").value = user.username;
    
    // üîë LOGIC HI·ªÇN TH·ªä COOLDOWN
    const cooldownEl = document.getElementById("username-cooldown");
    const usernameInput = document.getElementById("username");
    
    const now = Date.now();
    const lastChanged = new Date(user.usernameLastChangedAt || user.createdAt).getTime();
    const changeCount = user.usernameChangeCount || 0;
    const oneDay = 24 * 60 * 60 * 1000;
    
    let cooldownDays = 0;
    if (changeCount === 1) {
      cooldownDays = 7;
    } else if (changeCount >= 2) {
      cooldownDays = 14;
    }
    
    const cooldownDuration = cooldownDays * oneDay;
    const nextChangeTime = lastChanged + cooldownDuration;
    
    if (cooldownDays > 0 && now < nextChangeTime) {
      const remainingTimeMs = nextChangeTime - now;
      const remainingMessage = formatRemainingTime(remainingTimeMs);
      
      cooldownEl.style.color = "orange";
      cooldownEl.textContent = `Ch√≠nh s√°ch ƒë·ªïi t√™n: V·ª´a ƒë·ªïi ${changeCount} l·∫ßn. ${remainingMessage}`;
      
      // V√¥ hi·ªáu h√≥a √¥ nh·∫≠p li·ªáu t√™n ng∆∞·ªùi d√πng (ch·ªâ cho ph√©p ƒë·ªïi avatar/email)
      // usernameInput.disabled = true; // B·ªè comment n·∫øu mu·ªën ch·∫∑n nh·∫≠p
      
      // Th√™m ki·ªÉm tra tr∆∞·ªõc khi Submit
      usernameInput.dataset.cooldown = nextChangeTime; // L∆∞u th·ªùi gian ƒë·ªÉ ki·ªÉm tra l·∫°i khi submit
    } else {
      cooldownEl.style.color = "green";
      cooldownEl.textContent = changeCount === 0 
        ? "ƒê√¢y l√† l·∫ßn ƒë·ªïi t√™n ƒë·∫ßu ti√™n c·ªßa b·∫°n."
        : `B·∫°n ƒë√£ ƒë·ªïi t√™n ${changeCount} l·∫ßn. L·∫ßn ti·∫øp theo (th·ª© ${changeCount + 1}) s·∫Ω c√≥ cooldown ${changeCount === 1 ? '14' : '7'} ng√†y.`; // G·∫ßn ƒë√∫ng cho l·∫ßn ƒë·ªïi sau
      // usernameInput.disabled = false;
      usernameInput.dataset.cooldown = 0;
    }
    
  } catch(err) {
    // ... (X·ª≠ l√Ω l·ªói) ...
  }
}

// G·ªçi loadProfile() khi trang load
// loadProfile();
    // 1. Ki·ªÉm tra ƒëƒÉng nh·∫≠p
    const token = localStorage.getItem("token");
    if (!token) {
      alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p!");
      window.location.href = "login.html";
    }

    const form = document.getElementById("profile-form");
    const avatarInput = document.getElementById("avatar-input");
    const avatarPreview = document.getElementById("avatar-preview");
    const msg = document.getElementById("msg");
    const saveBtn = document.getElementById("save-btn");

    // 2. H√†m t·∫£i th√¥ng tin User
    async function loadProfile() {
      try {
        const res = await fetch("/auth/me", {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) {
           if(res.status === 401 || res.status === 403) {
             alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n.");
             localStorage.removeItem("token");
             window.location.href = "login.html";
             return;
           }
           throw new Error("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin.");
        }

        const user = await res.json();
        
        // G√°n d·ªØ li·ªáu v√†o form (S·ª≠ d·ª•ng || "" ƒë·ªÉ tr√°nh l·ªói undefined cho email)
        document.getElementById("email").value = user.email || "";
        document.getElementById("username").value = user.username;
        if (user.avatar) {
          avatarPreview.src = user.avatar;
        }

      } catch (err) {
        console.error(err);
        msg.style.color = "red";
        msg.textContent = "L·ªói t·∫£i h·ªì s∆°: " + err.message;
      }
    }

    // 3. Xem tr∆∞·ªõc ·∫£nh khi ch·ªçn file
    avatarInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        avatarPreview.src = URL.createObjectURL(file);
      }
    };

    // 4. X·ª≠ l√Ω C·∫¨P NH·∫¨T TH√îNG TIN (T√™n & Avatar)
    form.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = "ƒêang l∆∞u...";
      msg.style.color = "blue";
      saveBtn.disabled = true;

      const formData = new FormData();
      formData.append("username", document.getElementById("username").value);
      
      // Ch·ªâ g·ª≠i ·∫£nh n·∫øu ng∆∞·ªùi d√πng c√≥ ch·ªçn file m·ªõi
      if (avatarInput.files[0]) {
        formData.append("avatar", avatarInput.files[0]);
      }

      try {
        const res = await fetch("/auth/me", {
          method: "PUT",
          headers: { "Authorization": `Bearer ${token}` }, // FormData t·ª± set Content-Type
          body: formData
        });

        const data = await res.json();

        if (res.ok) {
          msg.style.color = "green";
          msg.textContent = "‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!";
          // C·∫≠p nh·∫≠t localStorage ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng ·ªü Navbar
          localStorage.setItem("username", data.user.username);
        } else {
          msg.style.color = "red";
          msg.textContent = "‚ùå " + (data.error || "C√≥ l·ªói x·∫£y ra");
        }
      } catch (err) {
        msg.style.color = "red";
        msg.textContent = "L·ªói k·∫øt n·ªëi server.";
      } finally {
        saveBtn.disabled = false;
      }
    };

    // 5. X·ª≠ l√Ω ƒê·ªîI M·∫¨T KH·∫®U
    const pwdForm = document.getElementById("change-password-form");
    const pwdMsg = document.getElementById("pwd-msg");
    const changePwdBtn = document.getElementById("change-pwd-btn");

    pwdForm.onsubmit = async (e) => {
      e.preventDefault();
      pwdMsg.textContent = "";
      
      const currentPassword = document.getElementById("current-password").value;
      const newPassword = document.getElementById("new-password").value;
      const confirmPassword = document.getElementById("confirm-password").value;

      // Validate Client
      if (newPassword !== confirmPassword) {
        pwdMsg.style.color = "red";
        pwdMsg.textContent = "‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!";
        return;
      }

      if (newPassword.length < 6) {
        pwdMsg.style.color = "red";
        pwdMsg.textContent = "‚ùå M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.";
        return;
      }

      changePwdBtn.disabled = true;
      changePwdBtn.textContent = "ƒêang x·ª≠ l√Ω...";

      try {
        const res = await fetch("/auth/change-password", {
          method: "PUT",
          headers: { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}` 
          },
          body: JSON.stringify({ currentPassword, newPassword })
        });

        const data = await res.json();

        if (res.ok) {
          pwdMsg.style.color = "green";
          pwdMsg.textContent = "‚úÖ " + data.message;
          pwdForm.reset(); // X√≥a tr·∫Øng form m·∫≠t kh·∫©u
        } else {
          pwdMsg.style.color = "red";
          pwdMsg.textContent = "‚ùå " + data.error;
        }
      } catch (err) {
        pwdMsg.style.color = "red";
        pwdMsg.textContent = "‚ùå L·ªói k·∫øt n·ªëi server.";
      } finally {
        changePwdBtn.disabled = false;
        changePwdBtn.textContent = "C·∫≠p nh·∫≠t m·∫≠t kh·∫©u";
      }
    };

    // Ch·∫°y khi t·∫£i trang
    loadProfile();
  </script>
</body>
</html>