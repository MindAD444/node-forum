<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H·ªì s∆° c√° nh√¢n - Forum</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <nav class="navbar">
    <div class="nav-left">
      <a href="home.html" class="nav-brand">Forum</a>
    </div>
  </nav>

  <main class="profile-container">
    <h2>H·ªì s∆° c√° nh√¢n</h2>
    
    <form id="profile-form">
      <div class="avatar-wrapper">
        <img id="avatar-preview"
     src="https://ui-avatars.com/api/?name=User&background=random"
     alt="Avatar" class="profile-avatar">
        <label for="avatar-input" class="upload-label">üì∑</label>
        <input type="file" id="avatar-input" accept="image/*">
      </div>

      <div class="form-group">
        <label>Email (Kh√¥ng th·ªÉ ƒë·ªïi)</label>
        <input type="text" id="email" disabled style="opacity: 0.7;">
      </div>

      <div class="form-group">
        <label>T√™n hi·ªÉn th·ªã</label>
        <input type="text" id="username" placeholder="Nh·∫≠p t√™n m·ªõi">
      </div>

      <p id="msg" style="margin-bottom: 10px; height: 20px;"></p>
      <button type="submit" class="save-btn" id="save-btn">L∆∞u thay ƒë·ªïi</button>
    </form>
  </main>
  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    const form = document.getElementById("profile-form");
    const avatarInput = document.getElementById("avatar-input");
    const avatarPreview = document.getElementById("avatar-preview");
    const msg = document.getElementById("msg");
    const saveBtn = document.getElementById("save-btn");

    // 1. T·∫£i th√¥ng tin user khi v√†o trang
    async function loadProfile() {
      try {
        const res = await fetch("/auth/me", {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const user = await res.json();
        
        if (res.ok) {
          document.getElementById("email").value = user.email;
          document.getElementById("username").value = user.username;
          if (user.avatar) {
            avatarPreview.src = user.avatar;
          }
        } else {
          alert("L·ªói t·∫£i th√¥ng tin");
        }
      } catch (err) {
        console.error(err);
      }
    }

    // 2. Hi·ªÉn th·ªã ·∫£nh xem tr∆∞·ªõc khi ch·ªçn file
    avatarInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        avatarPreview.src = URL.createObjectURL(file);
      }
    };

    // 3. X·ª≠ l√Ω l∆∞u th√¥ng tin
    form.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = "ƒêang l∆∞u...";
      saveBtn.disabled = true;

      const formData = new FormData();
      formData.append("username", document.getElementById("username").value);
      
      // N·∫øu c√≥ ch·ªçn ·∫£nh m·ªõi th√¨ g·ª≠i l√™n
      if (avatarInput.files[0]) {
        formData.append("avatar", avatarInput.files[0]);
      }

      try {
        const res = await fetch("/auth/me", {
          method: "PUT",
          headers: { "Authorization": `Bearer ${token}` }, // Kh√¥ng c·∫ßn Content-Type khi d√πng FormData
          body: formData
        });

        const data = await res.json();

        if (res.ok) {
          msg.style.color = "green";
          msg.textContent = "C·∫≠p nh·∫≠t th√†nh c√¥ng!";
          // C·∫≠p nh·∫≠t l·∫°i th√¥ng tin trong localStorage ƒë·ªÉ hi·ªÉn th·ªã ·ªü navbar
          localStorage.setItem("username", data.user.username);
        } else {
          msg.style.color = "red";
          msg.textContent = data.error || "C√≥ l·ªói x·∫£y ra";
        }
      } catch (err) {
        msg.textContent = "L·ªói k·∫øt n·ªëi server";
      } finally {
        saveBtn.disabled = false;
      }
    };

    loadProfile();
  </script>
</body>
</html>