<!DOCTYPE html>
<html lang="vi">
<head>
  <meta id="meta-title" name="title" content="">
  <meta id="meta-description" name="description" content="">
  <meta id="meta-og-title" property="og:title" content="">
  <meta id="meta-og-description" property="og:description" content="">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="page-title">ƒêang t·∫£i b√†i vi·∫øt...</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <nav class="navbar">
    <div class="nav-left">
      <a href="home.html" class="nav-brand">Forum</a>
    </div>
    <div class="nav-right">
      <a href="login.html" id="login-link" class="hidden">ƒêƒÉng nh·∫≠p</a>
    </div>
  </nav>

  <main class="container">
    <div id="post-detail" class="post-card">
        <h1 id="post-title"></h1>
        <div class="post-meta" style="margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">
            <small style="display: block;" id="post-author"></small>
            <small style="display: block;" id="post-date"></small>
        </div>
        <button id="delete-post-btn" class="delete-post-btn hidden" onclick="deletePost(postId)">‚ùå</button>
        <div id="post-content"></div>
        <div id="post-files" style="margin-top: 15px;"></div>
    </div>
    
    <h2 style="margin-top: 30px;">üí¨ B√¨nh lu·∫≠n</h2>
    <div id="comment-list"></div>
    <button id="load-more-comments" class="hidden load-more-btn">Xem th√™m</button>

    <form id="comment-form" class="hidden" style="margin-top: 20px;">
      <textarea id="comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." required></textarea>
      <button type="submit">ƒêƒÉng b√¨nh lu·∫≠n</button>
    </form>

    <p id="login-hint" style="margin-top: 20px;">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n.</p>

  </main>

  <div id="img-viewer" class="hidden" onclick="this.classList.add('hidden')">
    <img id="img-viewer-content" src="" alt="Viewed Image">
  </div>
  
  <script src="theme.js"></script>
  <script src="app.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('id');
    const commentForm = document.getElementById("comment-form");
    const loginHint = document.getElementById("login-hint");
    let commentPage = 1;
    const commentsPerPage = 10;

    // H√†m ti·ªán √≠ch format th·ªùi gian
    function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleDateString('vi-VN', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }

    // Hi·ªÉn th·ªã ·∫£nh l·ªõn
    function showImage(url) {
        const viewer = document.getElementById('img-viewer');
        document.getElementById('img-viewer-content').src = url;
        viewer.classList.remove('hidden');
    }

    // X√≥a b√†i vi·∫øt
    async function deletePost(postId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?")) return;

        const token = localStorage.getItem("token");
        try {
            const res = await fetch(`/posts/${postId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.ok) {
                alert("B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c x√≥a.");
                window.location.href = 'home.html';
            } else {
                const data = await res.json();
                alert(`L·ªói x√≥a b√†i: ${data.error || 'Kh√¥ng r√µ.'}`);
            }
        } catch (error) {
            alert("L·ªói k·∫øt n·ªëi server.");
        }
    }

    // ===========================================
    // LOGIC B√åNH LU·∫¨N
    // ===========================================
    async function loadComments(reset = false) {
        if (reset) {
            commentPage = 1;
            document.getElementById('comment-list').innerHTML = '';
        }

        try {
            const res = await fetch(`/comments/${postId}?page=${commentPage}&limit=${commentsPerPage}`);
            if (!res.ok) throw new Error("L·ªói khi t·∫£i b√¨nh lu·∫≠n");
            const data = await res.json();
            const list = document.getElementById('comment-list');

            if (data.comments && data.comments.length > 0) {
                const newComments = data.comments.map(c => renderComment(c)).join('');
                list.insertAdjacentHTML('beforeend', newComments);
            }

            // Hi·ªÉn th·ªã n√∫t "Xem th√™m" n·∫øu c√≤n trang
            if (data.totalPages && commentPage < data.totalPages) {
                document.getElementById('load-more-comments').classList.remove('hidden');
            } else {
                document.getElementById('load-more-comments').classList.add('hidden');
            }

            if (reset && (!data.comments || data.comments.length === 0)) {
                list.innerHTML = "<p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>";
            }

            commentPage++; // TƒÉng page sau khi t·∫£i xong
        } catch (err) {
            console.error("L·ªói t·∫£i b√¨nh lu·∫≠n:", err);
            document.getElementById('comment-list').innerHTML = "<p>L·ªói khi t·∫£i b√¨nh lu·∫≠n.</p>";
        }
    }

    function renderComment(comment) {
        const currentUserId = localStorage.getItem("userId");
        const isAdmin = localStorage.getItem("isAdmin") === 'true';
        const isOwner = comment.author?._id === currentUserId;

        const deleteBtn = (isAdmin || isOwner) ?
            `<button class="delete-comment-btn" onclick="deleteComment('${comment._id}')">‚ùå</button>` : '';

        return `
            <div class="comment-item" id="comment-${comment._id}">
                ${deleteBtn}
                <small style="display: block;"><strong>${comment.author?.username || "·∫®n danh"}</strong></small>
                <small style="display: block; color: var(--text-light);">${formatTime(comment.createdAt)}</small>
                <p style="margin-top: 5px;">${comment.content}</p>
            </div>
        `;
    }

    commentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = document.getElementById('comment-input').value.trim();
        const token = localStorage.getItem('token');

        if (!content || !token) return;

        try {
            const res = await fetch(`/comments/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ content })
            });
            if (res.ok) {
                document.getElementById('comment-input').value = '';
                loadComments(true);
            } else {
                alert("L·ªói khi ƒëƒÉng b√¨nh lu·∫≠n.");
            }
        } catch {
            alert("L·ªói k·∫øt n·ªëi server.");
        }
    });

    async function deleteComment(commentId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?")) return;

        const token = localStorage.getItem("token");
        try {
            const res = await fetch(`/comments/${commentId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.ok) {
                document.getElementById(`comment-${commentId}`).remove();
            } else {
                alert("L·ªói khi x√≥a b√¨nh lu·∫≠n.");
            }
        } catch (error) {
            alert("L·ªói k·∫øt n·ªëi server.");
        }
    }

    async function loadPostDetail() {
        if (!postId) {
            document.getElementById("post-detail").innerHTML = "<h1>B√†i vi·∫øt kh√¥ng t·ªìn t·∫°i.</h1><p>Kh√¥ng t√¨m th·∫•y ID b√†i vi·∫øt.</p>";
            return;
        }

        try {
            const res = await fetch(`/posts/${postId}`);
            if (!res.ok) {
                const errData = await res.json();
                document.getElementById("post-detail").innerHTML = `<h1>L·ªói</h1><p>${errData.error || "Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt."}</p>`;
                return;
            }

            const post = await res.json();

            // Set meta sau khi fetch th√†nh c√¥ng
            document.getElementById("meta-title").content = post.title;
            document.getElementById("meta-description").content = post.content.slice(0, 150);
            document.getElementById("meta-og-title").content = post.title;
            document.getElementById("meta-og-description").content = post.content.slice(0, 150);

            document.getElementById("page-title").textContent = post.title + " - Forum";
            document.getElementById("post-title").textContent = post.title;
            document.getElementById("post-author").innerHTML = `üë§ T√°c gi·∫£: ${post.author?.username || "·∫®n danh"}`;
            document.getElementById("post-date").innerHTML = `üïê ƒêƒÉng l√∫c: ${formatTime(post.createdAt)}`;
            document.getElementById("post-content").innerHTML = post.content.replace(/\n/g, '<br>');

            const currentUserId = localStorage.getItem("userId");
            const isAdmin = localStorage.getItem("isAdmin") === 'true';
            const deleteBtn = document.getElementById("delete-post-btn");

            if (isAdmin || (post.author && currentUserId === post.author._id)) {
                deleteBtn.classList.remove("hidden");
            } else {
                deleteBtn.classList.add("hidden");
            }

            if (post.files && post.files.length > 0) {
                const fileHtml = post.files.map(url => {
                    const isImage = /\.(jpe?g|png|gif|webp)$/i.test(url);
                    if (isImage) {
                        return `<img src="${url}" alt="File ƒë√≠nh k√®m" onclick="showImage('${url}')" style="max-width: 100%; max-height: 280px; object-fit: cover; border-radius: 8px; margin-top: 8px; cursor: pointer;">`;
                    }
                    return `<p><a href="${url}" target="_blank">üìé T·ªáp ƒë√≠nh k√®m</a></p>`;
                }).join("");
                document.getElementById("post-files").innerHTML = fileHtml;
            }

            loadComments(true);

        } catch (err) {
            console.error("L·ªói khi t·∫£i b√†i vi·∫øt:", err);
            document.getElementById("post-detail").innerHTML = "<h1>L·ªói k·∫øt n·ªëi</h1><p>Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt b√†i vi·∫øt.</p>";
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem('token');

        if (token) {
            commentForm.classList.remove('hidden');
            loginHint.classList.add('hidden');
            document.getElementById('login-link').classList.add('hidden');
        } else {
            commentForm.classList.add('hidden');
            loginHint.classList.remove('hidden');
            document.getElementById('login-link').classList.remove('hidden');
        }

        document.getElementById('load-more-comments').addEventListener('click', () => loadComments(false));

        loadPostDetail();
    });
</script>
</body>
</html>
