<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forum - Trang chá»§</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="nav-left">
      <button id="hamburger-btn" class="hamburger-btn">â˜°</button>
      <a href="home.html" class="nav-brand">Forum</a>
    </div>
    <div class="nav-right">
      <span id="username-display-nav"></span>
      <a href="login.html" id="login-link">ÄÄƒng nháº­p</a>
      <a href="register.html" id="register-link">ÄÄƒng kÃ½</a>
    </div>
  </nav>

  <!-- SIDEBAR -->
  <div id="sidebar" class="sidebar">
    <button id="close-sidebar-btn" class="close-sidebar-btn">&times;</button>
    <div id="sidebar-auth" class="hidden">
      <span id="username-display-sidebar"></span>
      <a href="create.html" id="create-link" class="sidebar-link hidden">ÄÄƒng bÃ i</a>
      <a href="admin.html" id="admin-link" class="sidebar-link hidden">Quáº£n trá»‹</a>
      <button id="logout-btn" class="sidebar-link sidebar-logout-btn hidden">ÄÄƒng xuáº¥t</button>
    </div>
    <div id="sidebar-guest" class="hidden">
      <p>Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ sá»­ dá»¥ng Ä‘áº§y Ä‘á»§ chá»©c nÄƒng</p>
      <a href="login.html" class="sidebar-link sidebar-primary-btn">ÄÄƒng nháº­p</a>
      <a href="register.html" class="sidebar-link sidebar-primary-btn">ÄÄƒng kÃ½</a>
    </div>
    <hr>
    <div class="sidebar-item">
      <span>Cháº¿ Ä‘á»™</span>
      <button id="theme-toggle" class="theme-toggle">ğŸŒ“</button>
    </div>
  </div>
  <div id="sidebar-overlay" class="sidebar-overlay"></div>

  <main class="container">
    <h1>Forum ThÃ´ng tin & Tháº£o Luáº­n</h1>

    <!-- TOGGLE SWITCH SIÃŠU Äáº¸P (HOáº T Äá»˜NG 100%) -->
    <div class="toggle-switch">
      <button class="toggle-btn active" data-tab="community">Cá»™ng Ä‘á»“ng</button>
      <button class="toggle-btn" data-tab="knowledge">ThÃ´ng tin</button>
      <div class="toggle-slider"></div>
    </div>

    <section id="community" class="tab-content active">
      <div id="posts" class="post-list">Äang táº£i bÃ i viáº¿t...</div>
    </section>

    <section id="knowledge" class="tab-content">
      <div id="knowledge-list" class="knowledge-placeholder">Äang táº£i thÃ´ng tin...</div>
    </section>
  </main>

  <script src="theme.js"></script>
  <script src="app.js"></script>
  <script>
    const formatTime = d => new Date(d).toLocaleDateString('vi-VN', {
      day:'2-digit', month:'2-digit', year:'numeric',
      hour:'2-digit', minute:'2-digit'
    });

    function renderPost(p) {
      const snippet = p.content.length > 100 ? p.content.substring(0,100)+'...' : p.content;
      return `
        <a href="post.html?id=${p._id}" class="post-card-link">
          <article class="post-card">
            <h3>${p.title}</h3>
            <p>${snippet.replace(/\n/g,'<br>')}</p>
            <div class="post-meta">
              <small>TÃ¡c giáº£: ${p.author?.username || "áº¨n danh"}</small><br>
              <small>ÄÄƒng lÃºc: ${formatTime(p.createdAt)}</small>
            </div>
          </article>
        </a>`;
    }

    async function loadCommunity() {
      const c = document.getElementById("posts");
      try {
        const res = await fetch("/posts");
        const posts = await res.json();
        c.innerHTML = posts.length ? posts.map(renderPost).join('') 
          : "<p class='empty-msg'>ChÆ°a cÃ³ bÃ i viáº¿t nÃ o. HÃ£y lÃ  ngÆ°á»i Ä‘áº§u tiÃªn!</p>";
      } catch {
        c.innerHTML = "<p class='error-msg'>KhÃ´ng thá»ƒ táº£i bÃ i viáº¿t</p>";
      }
    }
let currentPage = 1;
let isLoading = false;

async function loadKnowledge(page = 1, append = false) {
  const container = document.getElementById("knowledge-list");

  if (!append) {
    container.innerHTML = `
      <div class="knowledge-updates">
        <div class="knowledge-header">
          <h3>ThÃ´ng tin má»›i nháº¥t</h3>
          <button id="refresh-knowledge" class="refresh-btn" title="LÃ m má»›i">LÃ m má»›i</button>
        </div>
        <div id="knowledge-items"></div>
        <div id="knowledge-actions"></div>
      </div>`;
    currentPage = 1;
  }

  if (isLoading) return;
  isLoading = true;

  const itemsContainer = document.getElementById("knowledge-items");
  const actionsContainer = document.getElementById("knowledge-actions");

  // XÃ³a nÃºt cÅ©
  const oldBtn = document.getElementById('load-more-knowledge');
  if (oldBtn) oldBtn.remove();

  try {
    const res = await fetch(`/api/knowledge?page=${page}`);
    const data = await res.json();

    data.items.forEach(item => {
      const div = document.createElement('div');
      div.className = 'knowledge-item';
      div.innerHTML = `
        <h4>
          <a href="${item.link}" target="_blank" rel="noopener">
            ${item.title.length > 70 ? item.title.slice(0,67)+'...' : item.title}
          </a>
        </h4>
        <p class="k-desc">${item.desc}</p>
        <small class="k-date">
          ${new Date(item.date).toLocaleDateString('vi-VN', { 
            day: 'numeric', 
            month: 'short', 
            year: 'numeric' 
          })} 
          <span style="color: var(--primary-color); font-weight: bold;"> â€¢ </span>
          ${item.source || 'ThÃ´ng tin'}
        </small>
      `;
      itemsContainer.appendChild(div);
    });
    // NÃºt Xem thÃªm
    if (data.hasMore) {
      const btn = document.createElement('button');
      btn.id = 'load-more-knowledge';
      btn.className = 'load-more-btn';
      btn.textContent = 'Xem thÃªm thÃ´ng tin';
      btn.onclick = () => loadKnowledge(currentPage + 1, true);
      actionsContainer.appendChild(btn);
      currentPage++;
    } else if (append && data.items.length > 0) {
      actionsContainer.innerHTML = `<p style="text-align:center; color:var(--text-light); margin:20px 0;">
        ÄÃ£ háº¿t thÃ´ng tin hay hÃ´m nay
      </p>`;
    }

  } catch (err) {
    actionsContainer.innerHTML = `<p class="error-msg">Máº¡ng yáº¿u, Ä‘ang thá»­ láº¡i...</p>`;
  } finally {
    isLoading = false;
  }
}

// NÃºt lÃ m má»›i
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('knowledge-list').addEventListener('click', e => {
    if (e.target.id === 'refresh-knowledge') {
      e.target.disabled = true;
      e.target.textContent = 'Äang táº£i...';
      loadKnowledge(1, false).finally(() => {
        e.target.disabled = false;
        e.target.textContent = 'LÃ m má»›i';
      });
    }
  });
});

// Gá»i khi chuyá»ƒn tab
// (giá»¯ nguyÃªn pháº§n toggle tab, chá»‰ thÃªm dÃ²ng gá»i láº¡i loadKnowledge khi Ä‘á»•i category náº¿u cáº§n)
    // Toggle switch + tab
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
        btn.dataset.tab === 'community' ? loadCommunity() : loadKnowledge();
      };
    });

    // Sidebar
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    document.getElementById('hamburger-btn').onclick = () => {
      sidebar.classList.add('open'); overlay.classList.add('open');
    };
    document.getElementById('close-sidebar-btn').onclick = overlay.onclick = () => {
      sidebar.classList.remove('open'); overlay.classList.remove('open');
    };

    // Khá»Ÿi Ä‘á»™ng
    document.addEventListener('DOMContentLoaded', loadCommunity);
  </script>
</body>
</html>