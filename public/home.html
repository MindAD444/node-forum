<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forum - Trang ch·ªß</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">
      <span id="username-display"></span>
    </div>
    <div class="nav-right">
      <a href="index.html">Trang ch·ªß</a> <a href="create.html" id="create-link" class="hidden">ƒêƒÉng b√†i</a>
      <a href="admin.html" id="admin-link" class="hidden">Qu·∫£n tr·ªã</a>
      <a href="login.html" id="login-link">ƒêƒÉng nh·∫≠p</a> 
      <a href="register.html" id="register-link">ƒêƒÉng k√Ω</a>
      <button id="logout-btn" class="hidden">ƒêƒÉng xu·∫•t</button>
    </div>
  </nav>

  <main class="container">
    <h1>üìú Danh s√°ch b√†i vi·∫øt</h1>
    <div id="posts" class="post-list">ƒêang t·∫£i...</div>
  </main>

  <script>
    let currentUser = null; 

    document.addEventListener("DOMContentLoaded", () => {
      checkLoginStatus(); 
      setupEventListeners(); // Gi·ªØ l·∫°i h√†m n√†y
    });

    /**
     * H√†m ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p v√† t·∫£i th√¥ng tin user
     */
    async function checkLoginStatus() {
      const token = localStorage.getItem("token");
      
      if (!token) {
        loadPosts(); 
        document.getElementById("login-link").classList.remove("hidden");
        document.getElementById("register-link").classList.remove("hidden");
        return;
      }

      try {
        const res = await fetch("/me", {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) {
          localStorage.removeItem("token");
          loadPosts(); 
          return;
        }

        const user = await res.json(); 
        currentUser = user; 

        // --- C·∫≠p nh·∫≠t giao di·ªán ---
        document.getElementById("username-display").textContent = `üëã Ch√†o, ${user.username}`;
        document.getElementById("create-link").classList.remove("hidden");
        document.getElementById("logout-btn").classList.remove("hidden");
        document.getElementById("login-link").classList.add("hidden"); 
        document.getElementById("register-link").classList.add("hidden"); 
        if (user.isAdmin) { 
          document.getElementById("admin-link").classList.remove("hidden");
        }

        loadPosts();

      } catch (err) {
        console.error("L·ªói khi ki·ªÉm tra ƒëƒÉng nh·∫≠p:", err);
        localStorage.removeItem("token");
        loadPosts();
      }
    }


    /**
     * H√†m t·∫£i b√†i vi·∫øt (gi·ªØ nguy√™n logic)
     */
    async function loadPosts() {
      try {
        const res = await fetch("/posts");
        const posts = await res.json();
        const container = document.getElementById("posts");
        container.innerHTML = "";
        if (!posts.length) {
          container.innerHTML = "<p>Ch∆∞a c√≥ b√†i vi·∫øt n√†o ƒë∆∞·ª£c duy·ªát.</p>";
          return;
        }

        posts.filter(p => p.approved).forEach(post => {
          const div = document.createElement("div");
          div.className = "post-card";

          let fileHTML = "";
          if (post.files && post.files.length > 0) {
            fileHTML = `<div class="file-section"><strong>üìé T·ªáp ƒë√≠nh k√®m:</strong><br>`;
            post.files.forEach(f => {
              const ext = f.split('.').pop().toLowerCase();
              if (["jpg","jpeg","png","gif"].includes(ext)) {
                fileHTML += `<img src="${f}" class="post-image" alt="file" />`;
              } else {
                fileHTML += `<a href="${f}" target="_blank">${f.split("/").pop()}</a><br>`;
              }
            });
            fileHTML += `</div>`;
          }

          // Ki·ªÉm tra quy·ªÅn x√≥a b√†i vi·∫øt
          const canDeletePost = currentUser && (currentUser.isAdmin || currentUser._id === post.author?._id);

          div.innerHTML = `
            <h2>${post.title}</h2>
            <p>${post.content}</p>
            ${fileHTML}
            <div class="post-meta">
              üë§ <b>${post.author?.username || "·∫®n danh"}</b>
              &nbsp;‚Ä¢&nbsp; üïì ${new Date(post.createdAt).toLocaleString()}
            </div>
            
            <div class="post-actions">
              ${canDeletePost ? `<button class="delete-btn post-delete-btn" data-id="${post._id}">X√≥a b√†i</button>` : ""}
            </div>

            <div class="comment-section">
              <h4>B√¨nh lu·∫≠n</h4>
              
              <div class="comment-list" id="comments-${post._id}">ƒêang t·∫£i b√¨nh lu·∫≠n...</div>
              
              ${currentUser ? `
                <form class="comment-form" data-postid="${post._id}">
                  <textarea name="comment" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." required></textarea>
                  <button type="submit">G·ª≠i</button>
                </form>
              ` : `
                <p class="comment-login-prompt">
                  Vui l√≤ng <a href="login.html">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n.
                </p>
              `}
            </div>
          `;
          container.appendChild(div);

          loadComments(post._id);
        });
      } catch {
        document.getElementById("posts").innerHTML = "<p>L·ªói khi t·∫£i b√†i vi·∫øt.</p>";
      }
    }


    /**
     * Thi·∫øt l·∫≠p c√°c b·ªô l·∫Øng nghe s·ª± ki·ªán (gi·ªØ nguy√™n logic)
     */
    function setupEventListeners() {
        document.getElementById("posts").addEventListener("click", (e) => {
          // X·ª≠ l√Ω s·ª± ki·ªán click cho c√°c n√∫t X√≥a b√†i vi·∫øt
          if (e.target.classList.contains("post-delete-btn")) {
            const postId = e.target.dataset.id;
            deletePost(postId);
          } 
          // X·ª≠ l√Ω s·ª± ki·ªán click cho c√°c n√∫t X√≥a b√¨nh lu·∫≠n
          else if (e.target.classList.contains("comment-delete-btn")) { 
            const commentId = e.target.dataset.id;
            // L·∫•y postId ƒë·ªÉ t·∫£i l·∫°i b√¨nh lu·∫≠n sau khi x√≥a
            const commentList = e.target.closest('.comment-list');
            const postId = commentList.id.replace('comments-', ''); 
            deleteComment(commentId, postId);
          }
        });

        // X·ª≠ l√Ω s·ª± ki·ªán submit form b√¨nh lu·∫≠n
        document.getElementById("posts").addEventListener("submit", (e) => {
          if (e.target.classList.contains("comment-form")) {
            e.preventDefault();
            const postId = e.target.dataset.postid;
            const textarea = e.target.querySelector("textarea");
            const content = textarea.value.trim();
            
            if (content) {
              postComment(postId, content, textarea);
            }
          }
        });

        // X·ª≠ l√Ω n√∫t ƒêƒÉng xu·∫•t
        const logoutBtn = document.getElementById("logout-btn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", () => {
            localStorage.removeItem("token");
            currentUser = null; 
            window.location.reload();
          });
        }
    }

    // C√°c h√†m deletePost, loadComments, postComment, deleteComment (gi·ªØ nguy√™n logic)
    async function deletePost(postId) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y kh√¥ng?")) {
        return;
      }
      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`/posts/${postId}`, {
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        const data = await res.json();
        if (res.ok) {
          alert("X√≥a b√†i th√†nh c√¥ng!");
          loadPosts(); 
        } else {
          alert(data.message || "L·ªói khi x√≥a b√†i");
        }
      } catch (err) {
        alert("L·ªói server");
      }
    }

    async function loadComments(postId) {
      try {
        const res = await fetch(`/posts/${postId}/comments`);
        const comments = await res.json();
        const container = document.getElementById(`comments-${postId}`);
        
        if (!comments || !comments.length) {
          container.innerHTML = "<p class='no-comments'>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>";
          return;
        }

        container.innerHTML = ""; 
        comments.forEach(comment => {
          const div = document.createElement("div");
          div.className = "comment-item";

          const canDelete = currentUser && 
                            (currentUser.isAdmin || currentUser._id === comment.author._id);

          div.innerHTML = `
            <p><b>${comment.author.username}</b>: ${comment.content}</p>
            <span>${new Date(comment.createdAt).toLocaleString()}</span>
            ${canDelete ? `<button class="delete-btn comment-delete-btn" data-id="${comment._id}">X√≥a</button>` : ''}
          `;
          container.appendChild(div);
        });
      } catch (err) {
        document.getElementById(`comments-${postId}`).innerHTML = "<p>L·ªói t·∫£i b√¨nh lu·∫≠n.</p>";
      }
    }

    async function postComment(postId, content, textareaElement) {
      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`/posts/${postId}/comments`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ content })
        });
        
        const newComment = await res.json();

        if (res.ok) {
          textareaElement.value = ""; 
          const container = document.getElementById(`comments-${postId}`);
          const noCommentEl = container.querySelector('.no-comments');
          if(noCommentEl) noCommentEl.remove(); 
          
          const div = document.createElement("div");
          div.className = "comment-item";
          
          const canDelete = currentUser && 
                            (currentUser.isAdmin || currentUser._id === newComment.author._id);

          div.innerHTML = `
            <p><b>${newComment.author.username}</b>: ${newComment.content}</p>
            <span>${new Date(newComment.createdAt).toLocaleString()}</span>
            ${canDelete ? `<button class="delete-btn comment-delete-btn" data-id="${newComment._id}">X√≥a</button>` : ''}
          `;
          container.appendChild(div);

        } else {
          alert(newComment.message || "L·ªói khi ƒëƒÉng b√¨nh lu·∫≠n");
        }
      } catch (err) {
        alert("L·ªói server");
      }
    }

    async function deleteComment(commentId, postId) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?")) {
        return;
      }
      
      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`/comments/${commentId}`, { // D√πng route DELETE m·ªõi
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        const data = await res.json();
        if (res.ok) {
          alert("X√≥a b√¨nh lu·∫≠n th√†nh c√¥ng!");
          loadComments(postId); 
        } else {
          alert(data.message || "L·ªói khi x√≥a b√¨nh lu·∫≠n");
        }
      } catch (err) {
        alert("L·ªói server");
      }
    }
  </script>
</body>
</html>

